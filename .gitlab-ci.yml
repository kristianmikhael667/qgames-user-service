stages:
  - build
  - deploy
  - configure

variables:
  TAG_LATEST: $CI_REGISTRY_IMAGE/$CI_COMMIT_REF_NAME:latest
  TAG_COMMIT: $CI_REGISTRY_IMAGE/$CI_COMMIT_REF_NAME:$CI_COMMIT_SHORT_SHA
  APP_NAME: qgrowid-user
  PORT_NUMBER: 3504
  DB_NAME: qgrowid_users
  DB_USER: root
  BASE_URL: /inbox-service
  DOCKER_NETWORK: doomo-net
  K8S_DB_HOST: https://node18860-development.jh-beon.cloud
  K8S_DB_DRIVER: mysql
  K8S_TAG_LATEST: $CI_REGISTRY_IMAGE/$CI_COMMIT_REF_NAME-k8s:latest
  K8S_TAG_COMMIT: $CI_REGISTRY_IMAGE/$CI_COMMIT_REF_NAME-k8s:$CI_COMMIT_SHORT_SHA
  K8S_YAML: inbox-deploy.yaml
  K8S_SERVICE_YAML: inbox-service.yaml
  K8S_DPL_NAME: doomo-inbox-dpl
  K8S_NAMESPACE: doomo-development

build_k8s:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  before_script: 
    - echo -e "DB_NAME=$DB_NAME \n 
        DB_USER=$DB_USER \n
        DB_PASS=$DB_PASS \n
        DB_HOST=$DB_HOST \n
        JWT_SECRET= $JWT_SECRET" >> .env

  script:  
    - docker build -t $K8S_TAG_COMMIT -t $K8S_TAG_LATEST .
    - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN $CI_REGISTRY
    - docker push $K8S_TAG_COMMIT
    - docker push $K8S_TAG_LATEST
  only: 
    - dev


deploy_k8s:
  stage: deploy
  script:
    - chmod og= $ID_RSA_K8S
    - ssh -i $ID_RSA_K8S -o StrictHostKeyChecking=no $SERVER_USER@$SERVER_IP_K8S "cd qgrowid-cluster && git pull"
    - ssh -i $ID_RSA_K8S -o StrictHostKeyChecking=no $SERVER_USER@$SERVER_IP_K8S "cd qgrowid-cluster/deployments && kubectl apply -f $K8S_YAML"
    - ssh -i $ID_RSA_K8S -o StrictHostKeyChecking=no $SERVER_USER@$SERVER_IP_K8S "cd qgrowid-cluster/services && kubectl apply -f $K8S_SERVICE_YAML"
    - ssh -i $ID_RSA_K8S -o StrictHostKeyChecking=no $SERVER_USER@$SERVER_IP_K8S "kubectl rollout restart deployment $K8S_DPL_NAME -n $K8S_NAMESPACE"
  only:
    - dev 
